<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Event Reporting System - SQL Query Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
            display: flex;
            gap: 20px;
        }

        .left-panel {
            flex: 2;
        }

        .right-panel {
            flex: 1;
            min-width: 300px;
        }

        .query-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .query-box {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            background: #f8f9fa;
            transition: border-color 0.3s ease;
        }

        .query-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .sample-queries {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sample-queries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .query-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-width: 100px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .query-counter {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            color: #667eea;
            border: 2px solid #667eea;
            min-width: 80px;
            text-align: center;
        }

        .sample-query-container {
            position: relative;
        }

        .sample-query {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sample-query:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .sample-query h4 {
            color: #667eea;
            margin-bottom: 8px;
        }

        .sample-query pre {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            overflow-x: auto;
        }

        .results-section {
            margin-top: 30px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .api-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            z-index: 1000;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .schema-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            max-height: 80vh;
            overflow-y: auto;
        }

        .schema-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .table-schema {
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .table-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .table-name:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .table-name.expanded {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .column-list {
            margin-top: 10px;
            display: none;
        }

        .column-list.show {
            display: block;
        }

        .column-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #667eea;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-name {
            font-weight: bold;
            color: #333;
        }

        .column-type {
            color: #666;
            font-size: 0.8em;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .column-constraints {
            font-size: 0.7em;
            color: #28a745;
            font-weight: bold;
        }

        .schema-actions {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .schema-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .schema-btn-primary {
            background: #667eea;
            color: white;
        }

        .schema-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .schema-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .schema-loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .schema-error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }

        .quick-insert {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 5px 8px;
            font-size: 0.8em;
            color: #1976d2;
            cursor: pointer;
            margin-left: 5px;
            transition: all 0.3s ease;
        }

        .quick-insert:hover {
            background: #2196f3;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 20px;
                flex-direction: column;
            }
            
            .right-panel {
                min-width: auto;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="api-status" id="apiStatus">
        <span id="statusText">Checking API...</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>🎓 Campus Event Reporting System</h1>
            <p>SQL Query Interface - Write and execute queries directly in your browser</p>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="query-section">
                    <h2 class="section-title">📝 Write Your SQL Query</h2>
                
                <div class="sample-queries">
                    <div class="sample-queries-header">
                        <h3>💡 Sample Queries (Click to Use)</h3>
                        <div class="query-navigation">
                            <button class="nav-btn nav-btn-left" onclick="previousQuery()" id="prevBtn">◀ Previous</button>
                            <span class="query-counter" id="queryCounter">1 of 8</span>
                            <button class="nav-btn nav-btn-right" onclick="nextQuery()" id="nextBtn">Next ▶</button>
                        </div>
                    </div>
                    
                    <div class="sample-query-container">
                        <div class="sample-query" id="currentQuery" onclick="loadCurrentQuery()">
                            <h4 id="queryTitle">1. Total Registrations per Event</h4>
                            <pre id="queryCode">SELECT e.id, e.title, COUNT(r.id) AS registrations
FROM events e
LEFT JOIN registrations r ON r.event_id = e.id
WHERE e.college_id = 1
GROUP BY e.id, e.title
ORDER BY registrations DESC;</pre>
                        </div>
                    </div>
                </div>

                <textarea id="queryInput" class="query-box" placeholder="Enter your SQL query here...&#10;&#10;Example:&#10;SELECT * FROM events LIMIT 5;"></textarea>
                
                <div class="button-group">
                    <button class="btn btn-primary" onclick="executeQuery()">🚀 Execute Query</button>
                    <button class="btn btn-secondary" onclick="clearQuery()">🗑️ Clear</button>
                    <button class="btn btn-success" onclick="formatQuery()">✨ Format Query</button>
                </div>
            </div>

                <div class="results-section" id="resultsSection" style="display: none;">
                    <h2 class="section-title">📊 Query Results</h2>
                    <div id="resultsContent"></div>
                </div>
            </div>

            <div class="right-panel">
                <div class="schema-panel">
                    <h2 class="schema-title">🗂️ Database Schema</h2>
                    
                    <div class="schema-actions">
                        <button class="schema-btn schema-btn-primary" onclick="loadSchema()">🔄 Refresh Schema</button>
                        <button class="schema-btn schema-btn-secondary" onclick="expandAllTables()">📖 Expand All</button>
                        <button class="schema-btn schema-btn-secondary" onclick="collapseAllTables()">📕 Collapse All</button>
                    </div>
                    
                    <div id="schemaContent">
                        <div class="schema-loading">
                            🔄 Loading database schema...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';
        
        // Sample queries with titles
        const sampleQueries = [
            {
                title: "1. Total Registrations per Event",
                query: `SELECT e.id, e.title, COUNT(r.id) AS registrations
FROM events e
LEFT JOIN registrations r ON r.event_id = e.id
WHERE e.college_id = 1
GROUP BY e.id, e.title
ORDER BY registrations DESC;`
            },
            {
                title: "2. Attendance Percentage per Event",
                query: `SELECT e.id, e.title,
  COUNT(a.id) AS present,
  COUNT(r.id) AS registered,
  CASE WHEN COUNT(r.id)=0 THEN 0
       ELSE ROUND(100.0 * COUNT(a.id) / COUNT(r.id), 2) END AS attendance_pct
FROM events e
LEFT JOIN registrations r ON r.event_id = e.id
LEFT JOIN attendance a ON a.event_id = e.id AND a.student_id = r.student_id
WHERE e.college_id = 1
GROUP BY e.id, e.title
ORDER BY attendance_pct DESC;`
            },
            {
                title: "3. Average Feedback Score",
                query: `SELECT e.id, e.title, ROUND(AVG(f.rating), 2) AS avg_rating, COUNT(f.id) AS feedback_count
FROM events e
LEFT JOIN feedback f ON f.event_id = e.id
WHERE e.college_id = 1
GROUP BY e.id, e.title
ORDER BY avg_rating DESC;`
            },
            {
                title: "4. Top 3 Most Active Students",
                query: `SELECT s.id, s.name, s.email, COUNT(a.id) AS attended_events
FROM students s
JOIN attendance a ON a.student_id = s.id
WHERE s.college_id = 1
GROUP BY s.id, s.name, s.email
ORDER BY attended_events DESC
LIMIT 3;`
            },
            {
                title: "5. College Summary Statistics",
                query: `SELECT 
    COUNT(DISTINCT e.id) AS total_events,
    COUNT(DISTINCT r.id) AS total_registrations,
    COUNT(DISTINCT a.id) AS total_attendance,
    COUNT(DISTINCT f.id) AS total_feedback
FROM events e
LEFT JOIN registrations r ON r.event_id = e.id
LEFT JOIN attendance a ON a.event_id = e.id
LEFT JOIN feedback f ON f.event_id = e.id
WHERE e.college_id = 1;`
            },
            {
                title: "6. Events with Low Attendance",
                query: `SELECT e.title, 
       COUNT(r.id) as registered,
       COUNT(a.id) as attended,
       ROUND(100.0 * COUNT(a.id) / COUNT(r.id), 2) as attendance_pct
FROM events e
LEFT JOIN registrations r ON r.event_id = e.id
LEFT JOIN attendance a ON a.event_id = e.id AND a.student_id = r.student_id
WHERE e.college_id = 1
GROUP BY e.id, e.title
HAVING attendance_pct < 50
ORDER BY attendance_pct ASC;`
            },
            {
                title: "7. Recent Events (Last 30 days)",
                query: `SELECT e.title, e.start_time, e.location,
       COUNT(r.id) as registrations,
       COUNT(a.id) as attendance
FROM events e
LEFT JOIN registrations r ON r.event_id = e.id
LEFT JOIN attendance a ON a.event_id = e.id
WHERE e.start_time >= datetime('now', '-30 days')
GROUP BY e.id, e.title, e.start_time, e.location
ORDER BY e.start_time DESC;`
            },
            {
                title: "8. Student Participation by College",
                query: `SELECT c.name as college_name,
       COUNT(DISTINCT s.id) as total_students,
       COUNT(DISTINCT r.id) as total_registrations,
       COUNT(DISTINCT a.id) as total_attendance
FROM colleges c
LEFT JOIN students s ON s.college_id = c.id
LEFT JOIN registrations r ON r.student_id = s.id
LEFT JOIN attendance a ON a.student_id = s.id
GROUP BY c.id, c.name
ORDER BY total_attendance DESC;`
            }
        ];

        // Current query index
        let currentQueryIndex = 0;

        // Navigation functions
        function nextQuery() {
            if (currentQueryIndex < sampleQueries.length - 1) {
                currentQueryIndex++;
                updateQueryDisplay();
            }
        }

        function previousQuery() {
            if (currentQueryIndex > 0) {
                currentQueryIndex--;
                updateQueryDisplay();
            }
        }

        function updateQueryDisplay() {
            const queryTitle = document.getElementById('queryTitle');
            const queryCode = document.getElementById('queryCode');
            const queryCounter = document.getElementById('queryCounter');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const currentQuery = sampleQueries[currentQueryIndex];
            
            queryTitle.textContent = currentQuery.title;
            queryCode.textContent = currentQuery.query;
            queryCounter.textContent = `${currentQueryIndex + 1} of ${sampleQueries.length}`;

            // Update button states
            prevBtn.disabled = currentQueryIndex === 0;
            nextBtn.disabled = currentQueryIndex === sampleQueries.length - 1;
        }

        function loadCurrentQuery() {
            const queryInput = document.getElementById('queryInput');
            queryInput.value = sampleQueries[currentQueryIndex].query;
        }

        // Legacy function for backward compatibility
        function loadSampleQuery(index) {
            currentQueryIndex = index - 1;
            updateQueryDisplay();
            loadCurrentQuery();
        }

        // Initialize the display
        updateQueryDisplay();

        // Check API status on load
        window.addEventListener('load', function() {
            checkApiStatus();
            loadSchema(); // Load schema when page loads
        });

        async function checkApiStatus() {
            try {
                const response = await fetch(`${API_BASE_URL}/`);
                const statusElement = document.getElementById('apiStatus');
                const statusText = document.getElementById('statusText');
                
                if (response.ok) {
                    statusElement.className = 'api-status status-online';
                    statusText.textContent = '✅ API Online';
                } else {
                    throw new Error('API not responding');
                }
            } catch (error) {
                const statusElement = document.getElementById('apiStatus');
                const statusText = document.getElementById('statusText');
                statusElement.className = 'api-status status-offline';
                statusText.textContent = '❌ API Offline';
            }
        }

        function loadSampleQuery(index) {
            const queryInput = document.getElementById('queryInput');
            queryInput.value = sampleQueries[index - 1];
        }

        function clearQuery() {
            document.getElementById('queryInput').value = '';
            hideResults();
        }

        function formatQuery() {
            const queryInput = document.getElementById('queryInput');
            let query = queryInput.value.trim();
            
            // Basic SQL formatting
            query = query
                .replace(/\bSELECT\b/gi, 'SELECT')
                .replace(/\bFROM\b/gi, '\nFROM')
                .replace(/\bWHERE\b/gi, '\nWHERE')
                .replace(/\bGROUP BY\b/gi, '\nGROUP BY')
                .replace(/\bORDER BY\b/gi, '\nORDER BY')
                .replace(/\bLIMIT\b/gi, '\nLIMIT')
                .replace(/\bJOIN\b/gi, '\nJOIN')
                .replace(/\bLEFT JOIN\b/gi, '\nLEFT JOIN')
                .replace(/\bRIGHT JOIN\b/gi, '\nRIGHT JOIN')
                .replace(/\bINNER JOIN\b/gi, '\nINNER JOIN')
                .replace(/\bON\b/gi, '\n  ON')
                .replace(/\bAND\b/gi, '\n  AND')
                .replace(/\bOR\b/gi, '\n  OR');
            
            queryInput.value = query;
        }

        async function executeQuery() {
            const queryInput = document.getElementById('queryInput');
            const query = queryInput.value.trim();
            
            if (!query) {
                showError('Please enter a SQL query');
                return;
            }

            showLoading();
            
            try {
                const response = await fetch(`${API_BASE_URL}/execute-sql`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Query execution failed');
                }

                const data = await response.json();
                showResults(data);
            } catch (error) {
                showError(`Query execution failed: ${error.message}`);
            }
        }

        async function simulateQueryExecution(query) {
            // This simulates what would happen with a real API endpoint
            // You would need to add a /execute-sql endpoint to your FastAPI app
            
            // For now, we'll return sample data based on the query type
            if (query.toLowerCase().includes('registrations')) {
                return {
                    columns: ['id', 'title', 'registrations'],
                    rows: [
                        [1, 'Tech Conference 2024', 45],
                        [2, 'Business Workshop', 32],
                        [3, 'Arts Exhibition', 28],
                        [4, 'Engineering Seminar', 41],
                        [5, 'Medical Conference', 38]
                    ],
                    rowCount: 5
                };
            } else if (query.toLowerCase().includes('attendance')) {
                return {
                    columns: ['id', 'title', 'present', 'registered', 'attendance_pct'],
                    rows: [
                        [1, 'Tech Conference 2024', 42, 45, 93.33],
                        [2, 'Business Workshop', 28, 32, 87.50],
                        [3, 'Arts Exhibition', 25, 28, 89.29],
                        [4, 'Engineering Seminar', 35, 41, 85.37],
                        [5, 'Medical Conference', 30, 38, 78.95]
                    ],
                    rowCount: 5
                };
            } else if (query.toLowerCase().includes('feedback')) {
                return {
                    columns: ['id', 'title', 'avg_rating', 'feedback_count'],
                    rows: [
                        [1, 'Tech Conference 2024', 4.2, 38],
                        [2, 'Business Workshop', 3.8, 25],
                        [3, 'Arts Exhibition', 4.5, 22],
                        [4, 'Engineering Seminar', 4.0, 30],
                        [5, 'Medical Conference', 3.9, 28]
                    ],
                    rowCount: 5
                };
            } else if (query.toLowerCase().includes('students')) {
                return {
                    columns: ['id', 'name', 'email', 'attended_events'],
                    rows: [
                        [1, 'John Doe', 'john.doe@testuniversity.edu', 8],
                        [2, 'Jane Smith', 'jane.smith@testuniversity.edu', 7],
                        [3, 'Mike Johnson', 'mike.johnson@testuniversity.edu', 6]
                    ],
                    rowCount: 3
                };
            } else {
                // Generic result for other queries
                return {
                    columns: ['result'],
                    rows: [['Query executed successfully']],
                    rowCount: 1
                };
            }
        }

        function showLoading() {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = '<div class="loading">🔄 Executing query...</div>';
        }

        function showResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsSection.style.display = 'block';
            
            let html = `
                <div class="success">
                    ✅ Query executed successfully! Found ${data.row_count} rows in ${data.execution_time}s.
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-number">${data.row_count}</div>
                        <div class="stat-label">Rows Returned</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.columns.length}</div>
                        <div class="stat-label">Columns</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.execution_time}s</div>
                        <div class="stat-label">Execution Time</div>
                    </div>
                </div>
                
                <table class="results-table">
                    <thead>
                        <tr>
                            ${data.columns.map(col => `<th>${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.rows.map(row => `
                            <tr>
                                ${row.map(cell => `<td>${cell !== null ? cell : 'NULL'}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            resultsContent.innerHTML = html;
        }

        function showError(message) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContent = document.getElementById('resultsContent');
            
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = `<div class="error">❌ ${message}</div>`;
        }

        function hideResults() {
            document.getElementById('resultsSection').style.display = 'none';
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Execute query with Ctrl+Enter
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery();
            }
            // Navigate queries with arrow keys (when not typing in textarea)
            else if (e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'INPUT') {
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    previousQuery();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    nextQuery();
                }
            }
        });

        // Schema-related functions
        async function loadSchema() {
            const schemaContent = document.getElementById('schemaContent');
            schemaContent.innerHTML = '<div class="schema-loading">🔄 Loading database schema...</div>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/sql/schema`);
                if (!response.ok) {
                    throw new Error('Failed to load schema');
                }
                
                const schema = await response.json();
                displaySchema(schema);
            } catch (error) {
                schemaContent.innerHTML = `
                    <div class="schema-error">
                        ❌ Error loading schema: ${error.message}
                        <br><br>
                        <button class="schema-btn schema-btn-primary" onclick="loadSchema()">🔄 Retry</button>
                    </div>
                `;
            }
        }

        function displaySchema(schema) {
            const schemaContent = document.getElementById('schemaContent');
            let html = '';
            
            schema.tables.forEach(tableName => {
                const tableInfo = schema.schema[tableName];
                html += `
                    <div class="table-schema">
                        <div class="table-name" onclick="toggleTable('${tableName}')">
                            📋 ${tableName} (${tableInfo.column_count} columns)
                        </div>
                        <div class="column-list" id="columns-${tableName}">
                `;
                
                tableInfo.columns.forEach(column => {
                    const constraints = [];
                    if (column.primary_key) constraints.push('PK');
                    if (column.not_null) constraints.push('NOT NULL');
                    
                    html += `
                        <div class="column-item">
                            <span class="column-name">${column.name}</span>
                            <div>
                                <span class="column-type">${column.type}</span>
                                ${constraints.length > 0 ? `<span class="column-constraints">${constraints.join(', ')}</span>` : ''}
                                <span class="quick-insert" onclick="insertColumnName('${column.name}')">+</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            schemaContent.innerHTML = html;
        }

        function toggleTable(tableName) {
            const columnList = document.getElementById(`columns-${tableName}`);
            const tableNameElement = document.querySelector(`[onclick="toggleTable('${tableName}')"]`);
            
            if (columnList.classList.contains('show')) {
                columnList.classList.remove('show');
                tableNameElement.classList.remove('expanded');
            } else {
                columnList.classList.add('show');
                tableNameElement.classList.add('expanded');
            }
        }

        function expandAllTables() {
            const columnLists = document.querySelectorAll('.column-list');
            const tableNames = document.querySelectorAll('.table-name');
            
            columnLists.forEach(list => list.classList.add('show'));
            tableNames.forEach(name => name.classList.add('expanded'));
        }

        function collapseAllTables() {
            const columnLists = document.querySelectorAll('.column-list');
            const tableNames = document.querySelectorAll('.table-name');
            
            columnLists.forEach(list => list.classList.remove('show'));
            tableNames.forEach(name => name.classList.remove('expanded'));
        }

        function insertColumnName(columnName) {
            const queryInput = document.getElementById('queryInput');
            const currentValue = queryInput.value;
            const cursorPos = queryInput.selectionStart;
            
            // Insert the column name at cursor position
            const newValue = currentValue.substring(0, cursorPos) + columnName + currentValue.substring(cursorPos);
            queryInput.value = newValue;
            
            // Set cursor position after the inserted text
            const newCursorPos = cursorPos + columnName.length;
            queryInput.setSelectionRange(newCursorPos, newCursorPos);
            queryInput.focus();
        }
    </script>
</body>
</html>
